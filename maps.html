<!doctype html>

<head>
  <meta charset="utf-8">
  <title>bastienchamp.com</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body { height: 100%; margin: 0; padding: 0; background: #FAFAFA; }
    #map { height: calc(100vh); width: 100%; }
    .bottom-bar, .top-bar, .left-bar, .right-bar { position: fixed; background: #FAFAFA; }
    .bottom-bar { left: 0; right: 0; bottom: 0; height: 2.66vh; }
    .top-bar { left: 0; right: 0; top: 0; height: 2.66vh; }
    .left-bar { left: 0; top: 0; bottom: 0; width: 2.66vh; }
    .right-bar { right: 0; top: 0; bottom: 0; width: 2.66vh; }

    /* Modale fixe ‚Äî en bas √† gauche (clic) */
    .custom-modal {
      position: fixed;
      bottom: 6vh;
      left: 6vh;
      background: white;
      padding: 18px 24px; /* plus de bouton bas ‚Üí padding normal */
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      font-size: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      z-index: 9999;
      max-width: 260px;
      line-height: 1.35;
      text-align: left;

      /* Fade-in / out */
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transform: translateY(6px);
      transition: opacity .18s ease, transform .18s ease, visibility 0s linear .18s, border-color .18s ease;

      border: 2px solid transparent; /* mis √† jour dynamiquement avec la couleur du trajet */
    }
    .custom-modal.is-visible {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
      transform: translateY(0);
      transition: opacity .18s ease, transform .18s ease, visibility 0s;
    }

    /* Ligne du header (year + croix) */
    .custom-modal .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 6px;
    }

    .custom-modal .title { font-weight: 600; margin-bottom: 6px; }
    .custom-modal .year { font-size: 14px; }
    .custom-modal .bike { font-size: 14px; margin-top: 4px; margin-bottom: 6px; }
    .custom-modal .link { font-size: 13px; color: #0066cc; word-break: break-all; }

    /* Croix de fermeture en haut-droite (align√©e avec year) */
    .custom-modal .close-x {
      width: 24px; height: 24px;
      line-height: 24px;
      text-align: center;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 18px;
      color: #666;
      padding: 0;
    }
    .custom-modal .close-x:hover { color: #111; }

    /* Tooltip (hover) ‚Äî pr√®s du curseur, sans bike ni link */
    .hover-modal {
      display: none;
      position: fixed;
      background: white;
      padding: 10px 12px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      font-size: 13.5px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      z-index: 10000;
      max-width: 260px;
      line-height: 1.35;
      text-align: left;
      pointer-events: none;
    }
    .hover-modal .title { font-weight: 600; margin-top: 2px; }
    .hover-modal .year { opacity: 0.9; }
  </style>
</head>

<body>
  <div id="map"></div>
  <div class="bottom-bar"></div>
  <div class="top-bar"></div>
  <div class="left-bar"></div>
  <div class="right-bar"></div>

  <!-- Modale fixe (clic) -->
  <div id="trackModal" class="custom-modal"></div>
  <!-- Tooltip (hover) -->
  <div id="hoverModal" class="hover-modal"></div>

  <script>
    function initMap() {
      const position = { lat: 45.880131, lng: 10.182550 };

      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 7.75,
        center: position,
        disableDefaultUI: true,
        keyboardShortcuts: false,
        disableDoubleClickZoom: true,
        draggable: false,
        gestureHandling: "none",
      });

      const gpxFiles = [
        'resources/gpx/17D1.gpx','resources/gpx/17D2.gpx','resources/gpx/17D3.gpx','resources/gpx/17D4.gpx','resources/gpx/17D5.gpx','resources/gpx/17D6.gpx','resources/gpx/17D7.gpx',
        'resources/gpx/20D1.gpx','resources/gpx/20D2.gpx','resources/gpx/20D3.gpx','resources/gpx/20D4.gpx',
        'resources/gpx/21D1.gpx','resources/gpx/21D2.gpx','resources/gpx/21D3.gpx','resources/gpx/21D4.gpx','resources/gpx/21D5.gpx','resources/gpx/21D6.gpx','resources/gpx/21D7.gpx','resources/gpx/21D8.gpx',
        'resources/gpx/23D1.gpx','resources/gpx/23D2.gpx','resources/gpx/23D3.gpx',
        'resources/gpx/24D1.gpx','resources/gpx/24D2.gpx',
        'resources/gpx/25D1.gpx','resources/gpx/25D2.gpx'
      ];

      const colorByPrefix = {
        '17': '#EB3D4D', '20': '#3D55EB', '21': '#EBA73D', '23': '#82BEEF', '24': '#968759', '25': '#6B5154',
      };

      const modal = document.getElementById('trackModal');
      const hoverModal = document.getElementById('hoverModal');

      // √âtat de lock (modale fixe)
      let lockedPolyline = null, lockedShadow = null;

      // Styles
      const baseMain = { weight: 3,  opacity: 1.0 };
      const hoverMain= { weight: 6,  opacity: 1.0 };
      const baseShad = { weight: 7,  opacity: 0.35 };
      const hoverShad= { weight: 11, opacity: 0.6  };

      // Debounce
      let hoverTimer = null;
      const HOVER_DELAY = 80;

      const esc = (s)=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');

      function renderContent({ year, trackName, bike, linkHref, includeLink, includeBike }) {
        return `
          ${year ? `<div class="year">${esc(year)}</div>` : ''}
          <div class="title">${esc(trackName)}</div>
          ${includeBike && bike ? `<div class="bike">üèçÔ∏è ${esc(bike)}</div>` : ''}
          ${includeLink && linkHref ? `<div class="link"><a href="${esc(linkHref)}" target="_blank">Voir l‚Äôitin√©raire</a></div>` : ''}
        `;
      }

      // === CHANG√â : croix en haut, fade-in/out, bordure couleur trajet ===
      function showFixedModal(data, borderColor) {
        modal.innerHTML = `
          <div class="modal-header">
            ${data.year ? `<div class="year">${esc(data.year)}</div>` : `<div class="year"></div>`}
            <button class="close-x" type="button" aria-label="Fermer">√ó</button>
          </div>
          <div class="title">${esc(data.trackName)}</div>
          ${data.bike ? `<div class="bike">üèçÔ∏è ${esc(data.bike)}</div>` : ''}
          ${data.linkHref ? `<div class="link"><a href="${esc(data.linkHref)}" target="_blank">Voir l‚Äôitin√©raire</a></div>` : ''}
        `;
        modal.style.borderColor = borderColor || '#cccccc';
        modal.classList.add('is-visible');

        const closeBtn = modal.querySelector('.close-x');
        closeBtn.onclick = (ev) => {
          ev.stopPropagation();
          closeFixedModal();
        };
      }

      function closeFixedModal() {
        modal.classList.remove('is-visible');
        // Restaure le style si une ligne est lock√©e
        if (lockedPolyline && lockedShadow) {
          applyBaseStyle(lockedPolyline, lockedShadow);
        }
        lockedPolyline = null; lockedShadow = null;
      }

      function showHoverModalAt(data, x, y) {
        // Tooltip hover : pas de bike, pas de link
        hoverModal.innerHTML = `
          ${data.year ? `<div class="year">${esc(data.year)}</div>` : ''}
          <div class="title">${esc(data.trackName)}</div>
        `;
        const offset = 12;
        hoverModal.style.left = (x + offset) + 'px';
        hoverModal.style.top  = (y + offset) + 'px';
        hoverModal.style.display = 'block';
      }
      function debouncedHover(data, x, y) {
        clearTimeout(hoverTimer);
        hoverTimer = setTimeout(() => showHoverModalAt(data, x, y), HOVER_DELAY);
      }
      function hideHoverModal() { clearTimeout(hoverTimer); hoverModal.style.display = 'none'; }

      function applyHoverStyle(poly, shad) {
        poly.setOptions({ strokeWeight: hoverMain.weight, strokeOpacity: hoverMain.opacity });
        shad.setOptions({ strokeWeight: hoverShad.weight, strokeOpacity: hoverShad.opacity });
      }
      function applyBaseStyle(poly, shad) {
        poly.setOptions({ strokeWeight: baseMain.weight, strokeOpacity: baseMain.opacity });
        shad.setOptions({ strokeWeight: baseShad.weight, strokeOpacity: baseShad.opacity });
      }

      gpxFiles.forEach(file => {
        fetch(file).then(r => {
          if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.text();
        }).then(gpxText => {
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(gpxText, "application/xml");

          const trk = xmlDoc.getElementsByTagName('trk')[0];
          const nameNode = trk ? trk.getElementsByTagName('name')[0] : null;
          const yearNode = trk ? trk.getElementsByTagName('year')[0] : null;
          const bikeNode = trk ? trk.getElementsByTagName('bike')[0] : null;
          const linkNode = trk ? trk.getElementsByTagName('link')[0] : null;

          const trackName = nameNode ? nameNode.textContent.trim() : 'Trajet';
          const year = yearNode ? yearNode.textContent.trim() : '';
          const bike = bikeNode ? bikeNode.textContent.trim() : '';
          const linkHref = linkNode ? linkNode.getAttribute('href') : '';

          const trkpts = xmlDoc.getElementsByTagName('trkpt');
          const coords = [];
          for (let i = 0; i < trkpts.length; i++) {
            const lat = parseFloat(trkpts[i].getAttribute('lat'));
            const lon = parseFloat(trkpts[i].getAttribute('lon'));
            coords.push({ lat, lng: lon });
          }

          const match = file.match(/\/(\d{2})[^/]*\.gpx$/i);
          const prefix = match ? match[1] : null;
          const strokeColor = (prefix && colorByPrefix[prefix]) ? colorByPrefix[prefix] : undefined;

          // Ombre
          const shadowPolyline = new google.maps.Polyline({
            path: coords, geodesic: true,
            strokeColor: "#000000", strokeOpacity: baseShad.opacity, strokeWeight: baseShad.weight, zIndex: 1
          });
          shadowPolyline.setMap(map);

          // Ligne
          const polyline = new google.maps.Polyline({
            path: coords, geodesic: true,
            ...(strokeColor ? { strokeColor } : {}),
            strokeOpacity: baseMain.opacity, strokeWeight: baseMain.weight, zIndex: 2
          });
          polyline.setMap(map);

          const data = { year, trackName, bike, linkHref };

          // Hover
          polyline.addListener('mouseover', (e) => {
            if (lockedPolyline && lockedPolyline !== polyline) {
              applyBaseStyle(lockedPolyline, lockedShadow);
              lockedPolyline = null; lockedShadow = null;
            }
            const x = e.domEvent ? e.domEvent.clientX : window.innerWidth/2;
            const y = e.domEvent ? e.domEvent.clientY : window.innerHeight/2;
            debouncedHover(data, x, y);
            applyHoverStyle(polyline, shadowPolyline);
          });
          polyline.addListener('mousemove', (e) => {
            const x = e.domEvent ? e.domEvent.clientX : window.innerWidth/2;
            const y = e.domEvent ? e.domEvent.clientY : window.innerHeight/2;
            debouncedHover(data, x, y);
          });
          polyline.addListener('mouseout', () => {
            hideHoverModal();
            if (lockedPolyline !== polyline) applyBaseStyle(polyline, shadowPolyline);
          });

          // Clic (modale fixe + lock) ‚Äî bordure = couleur du trajet
          polyline.addListener('click', () => {
            if (lockedPolyline && lockedPolyline !== polyline) applyBaseStyle(lockedPolyline, lockedShadow);
            lockedPolyline = polyline; lockedShadow = shadowPolyline;
            showFixedModal(data, strokeColor || '#cccccc');
            applyHoverStyle(polyline, shadowPolyline);
          });

        }).catch(err => console.error(`Erreur GPX (${file}):`, err));
      });
    }
  </script>

  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD-pBG0rqLOKQWGkhIjjHHoDIWbwimusJE&callback=initMap"></script>
</body>
</html>